# 整体结构设计

> 2024年12月23日 刘绍阳

*若有更新，我将在此继续补充相关信息*

### 一、文件结构设计

以下为根目录视角。

- **TankWar.cpp**   整个程序的入口函数`WinMain`所在的源文件。
- **Union.h** 联合头文件（该头文件包含了其他所有头文件，其他头文件仅需引用该头文件即可避免*Multiple Definition*问题。
- **Console.h & Console.cpp** 负责需要输出至控制台的相关操作，同样的，前者负责声明，后者负责定义。下文用一个 ***“对”*** 来代指这种关系。
- **Macro.h** 你可能已经注意到，这个头文件没有对应的源代码文件。这是因为这个文件只负责全局变量的定义，所以其不需要额外的源文件来实现。
- **Core.h & Core.cpp** 游戏根类所在的头文件和源文件。
- **Timer.h** 程序的计时器类。
- ~~**Graphics.h & Graphic.cpp** 两者负责SDL的相关功能的初始化和聚合，前者负责声明，后者负责定义。~~ *已经被弃用，其功能移至其他头文件*


### 二、代码结构设计

由上文`（一）文件结构设计`我们已经知道了源代码文件的结构分别，接下来由我来陈述事关具体代码设计的结构组织方式。这个部分用以指导开发团队成员以理解由其他人编写的模块，和增加不同成员编写的代码的一致性。

**TankWar.cpp**

游戏的主文件，其中入口函数`WinMain(int argc, char** args)`就定义在这里。在这里能够见到整体的、最高层的执行逻辑:
+ 创建GAME对象
+ 执行GAME对象中的`run()`函数（try catch）
+ GAME对象的主循环结束，资源得到销毁，返回了相关值
+ 处理相关值，然后给出返回值，程序结束

**Core.h "_CORE_H_"**

该头文件包含了游戏的核心类`GAME_CORE`，在该类结构中的私有成员中声明了当前窗口的**SDL句柄(*SDL_Window\**)** 以及游戏的**根计时器(*Timer*)**，以及随SDL初始化而获得的**根渲染器(*SDL_Renderer\**)**。同时在公有成员中提供了游戏的**初始化方法`Init()`**、**资源加载方法`Load()`**、**主循环方法`MainLoop()`**，以及**资源回收方法`CleanUp()`**。


在该类的私有成员中，我们声明了诸如（*SDL_Window\**）、 （*SDL_surface\**） 等等变量，其中`SDL_Window* window`则是我们在`Init()`函数中获取的窗口句柄（这里借用了Win32 API中HWND的窗口句柄概念，即当前创建而运行的窗口的地址）。其他的变量则分别指向本窗口的窗口表面（*Surface*），我们`Load()`的材质资源等等。可以见得，这些都是在SDL窗口运行的生命周期中一直需要存在的数据，他们随着SDL窗口的初始化得得以赋值（在**Graphics.cpp**中定义），随着SDL窗口的关闭而在`CleanUp()`中得到释放。这种***析构则释放***的思路应当贯彻始终，确保资源得到最大程度的保留。而将***声明和定义分开***的结构思路更加有益于增加我们代码的可读性，*因为在绝大多数情况下，当我们浏览代码时，我们不需要去关注那些具体的代码实现，我们应该做的是尽快地了解代码执行的顺序和整体组织的结构。*

**Timer.h _TIMER_H_**

该头文件没有对应的源代码实现文件，因为其功能简单。其中包含了**Timer类**，该类的主要作用是记录从对象生成到调用时所经过的时间(以帧数为单位)。该类有一些基础方法，例如`Timer.GetTime()`则会返回*int类型*的帧数、`Timer.SetTime(int eTime)`则会将计时器的时间设置为***eTime***的值。**Timer**的计时器功能依赖于每循环调用一次**Timer**的`Timer.OnUpdate()`方法，每次调用这个方法都会使得**Timer**内部的**eTime**自加1（当达到帧率上限时归零）。

*Core.h* 中所声明的根**Timer**是用来同步各个模块的计时器，模块可以声明自己的计时器对象以符合自身的需求，例如**Animation**对象为了保证动画的合理性，应当依照自身的计时器来调整动画而并非根计时器，倘若依赖根计时器则会导致页面上所有动画同步播放，而这种情况在一些条件下是不合理的。

**Macro.h "_MACRO_H_"**

顾名思义，这个头文件以 **宏（Macro）** 为名，其中的内容也是关于宏定义。在所有的源代码中引用这个头文件，这些宏在所有的源代码中指向的具体值一致，则相当于声明了全局常量。这些全局常量包括：
+ 程序名称
+ 版本号
+ 窗口尺寸
+ and more...


**Console.h "_CONSOLE_H_"**

在开发阶段，具体代码的执行结果常常是不可知的。为了避免开发环境变成暗箱，在开发过程中我们就可以设计一些锚点，输出适时正在处理的数据，这样一来，倘若遇到错误，便可通过分析日志来排除错误（即**DEBUG**）。给这些输出数据的手段以统一的定义，即可以增加编码风格的一致性，也可以便于在开发完成后的阶段，我们去除控制台和日志画面（成品游戏不应该显示后台的日志），适时我们只需要将相关函数指向的窗口指向空即可。

~~**Graphics.h "_GRAPHICS_H_"**~~ *已被废弃*